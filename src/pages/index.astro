---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar';
import ImageCarousel from '../components/ImageCarousel';
import '../styles/global.css';
import { Image } from 'astro:assets';
import { loadQuery } from "../sanity/lib/load-query";

interface Project {
  title: string;
  favoriteImages: string[];
}

interface Image {
  title: string;
  url: string;
}

const query = `
{
  "projects": *[_type == "projects"]{
    title,
    "favoriteImages": projectImages[isFavorite == true].asset->url
  },
  "documentation": *[_type == "documentation"]{
    title,
    "favoriteImages": documentationImages[isFavorite == true].asset->url
  },
  "fashion": *[_type == "fashion"]{
    title,
    "favoriteImages": fashionImages[isFavorite == true].asset->url
  },
  "portraits": *[_type == "portraits"]{
    title,
    "favoriteImages": portraitsImages[isFavorite == true].asset->url
  },
  "random": *[_type == "random"]{
    title,
    "favoriteImages": randomImages[isFavorite == true].asset->url
  }
}
`;

const { data } = await loadQuery<{
  projects: Project[];
  documentation: Project[];
  fashion: Project[];
  portraits: Project[];
  random: Project[];
}>({ query });

// Combine all favorite images into a single array
const unfilteredFavoriteImages: Image[] = [
  ...data.projects.flatMap(doc => 
    doc.favoriteImages.map(url => ({ title: doc.title, url }))
  ),
  ...data.documentation.flatMap(doc => 
    doc.favoriteImages.map(url => ({ title: doc.title, url }))
  ),
  ...data.fashion.flatMap(doc => 
    doc.favoriteImages.map(url => ({ title: doc.title, url }))
  ),
  ...data.portraits.flatMap(doc => 
    doc.favoriteImages.map(url => ({ title: doc.title, url }))
  ),
  ...data.random.flatMap(doc => 
    doc.favoriteImages.map(url => ({ title: doc.title, url }))
  )
];

// Fisher-Yates shuffle algorithm
function shuffleArray<T>(array: T[]): T[] {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Create shuffled version of the favorites array
const favoriteImages = shuffleArray(unfilteredFavoriteImages);
---

<Layout title="Lily Ballif">
	<Navbar client:load />
	<div id="image-grid" class="flex overflow-x-scroll no-scroll-bar pl-[20px] pb-[20px]">
		{favoriteImages.map((image, index) => (
			<div class="flex-shrink-0">
				<Image 
                    src={image.url} 
                    alt={image.title}
                    width={800}
                    height={1200}
                    class="h-[55svh] md:h-[60svh] w-auto pr-[0.5rem] cursor-pointer hover-shrink"
                    data-index={index}
                    loading={index < 5 ? "eager" : "lazy"}
                    format="webp"
                    quality={80}
                />
				<p class="pt-[0.5rem]">{image.title}</p>
			</div>
		))}
	</div>
	<ImageCarousel client:load images={favoriteImages} />
</Layout>

<style>
    .no-scroll-bar {
        scrollbar-width: none;
        overflow-x: scroll; /* Allow horizontal scrolling */
    }
    .no-scroll-bar::-webkit-scrollbar {
        display: none;
    }
    .hover-shrink {
        transition: transform 0.3s ease;
    }
    .hover-shrink:hover {
        transform: scale(0.975);
    }
</style>

<script is:inline>
    let isCarouselOpen = false;
    let currentIndex = 0;

    function openCarousel(index) {
        isCarouselOpen = true;
        currentIndex = index;
        updateCarousel();
    }

    function closeCarousel() {
        isCarouselOpen = false;
        updateCarousel();
    }

    function updateCarousel() {
        const event = new CustomEvent('updateCarousel', { 
            detail: { isOpen: isCarouselOpen, index: currentIndex } 
        });
        window.dispatchEvent(event);
    }

    // Add click listeners to images
    document.addEventListener('DOMContentLoaded', () => {
        const imageGrid = document.getElementById('image-grid');
        if (imageGrid) {
            imageGrid.addEventListener('click', (e) => {
                if (e.target instanceof HTMLImageElement) {
                    const index = parseInt(e.target.getAttribute('data-index') || '0', 10);
                    openCarousel(index);
                }
            });
        }
    });

    // Listen for close events from the carousel
    window.addEventListener('closeCarousel', closeCarousel);

    // Add horizontal scrolling with mouse wheel
    document.addEventListener('DOMContentLoaded', () => {
        const imageGrid = document.getElementById('image-grid');
        if (imageGrid) {
            imageGrid.addEventListener('wheel', (e) => {
                if (e.deltaY !== 0) {
                    e.preventDefault();
                    imageGrid.scrollLeft += e.deltaY;
                }
            });
        }
    });
</script>