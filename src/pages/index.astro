---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar';
import ImageCarousel from '../components/ImageCarousel';
import '../styles/global.css';

import { loadQuery } from "../sanity/lib/load-query";

interface Project {
  title: string;
  favoriteImages: string[];
}

interface Image {
  title: string;
  url: string;
}

const query = `
*[_type == "projects"]{
  title,
  "favoriteImages": projectImages[isFavorite == true].asset->url
}
`;
const { data: projects } = await loadQuery<Project[]>({ query });

const favoriteImages: Image[] = projects.flatMap(project => 
  project.favoriteImages.map(url => ({ title: project.title, url }))
);
---

<Layout title="Welcome to Astro.">
	<Navbar client:load />
	<div id="image-grid" class="flex overflow-x-scroll no-scroll-bar pl-[1rem] pb-[1rem]">
		{favoriteImages.map((image, index) => (
			<div class="flex-shrink-0">
				<img 
					src={image.url} 
					alt={image.title} 
					class="h-[50vh] w-auto pr-[0.5rem] cursor-pointer" 
					data-index={index}
				/>
				<p>{image.title}</p>
			</div>
		))}
	</div>
	<ImageCarousel client:load images={favoriteImages} />
</Layout>

<style>
    .no-scroll-bar {
        scrollbar-width: none;
    }
    .no-scroll-bar::-webkit-scrollbar {
        display: none;
    }
</style>

<script is:inline>
    let isCarouselOpen = false;
    let currentIndex = 0;

    function openCarousel(index) {
        isCarouselOpen = true;
        currentIndex = index;
        updateCarousel();
    }

    function closeCarousel() {
        isCarouselOpen = false;
        updateCarousel();
    }

    function updateCarousel() {
        const event = new CustomEvent('updateCarousel', { 
            detail: { isOpen: isCarouselOpen, index: currentIndex } 
        });
        window.dispatchEvent(event);
    }

    // Add click listeners to images
    document.addEventListener('DOMContentLoaded', () => {
        const imageGrid = document.getElementById('image-grid');
        if (imageGrid) {
            imageGrid.addEventListener('click', (e) => {
                if (e.target instanceof HTMLImageElement) {
                    const index = parseInt(e.target.getAttribute('data-index') || '0', 10);
                    openCarousel(index);
                }
            });
        }
    });

    // Listen for close events from the carousel
    window.addEventListener('closeCarousel', closeCarousel);
</script>